name: Build & Push Zandronum Server (Docker Hub)

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: "Docker Hub image name (e.g., lancommander/zandronum)"
        required: true
        default: "lancommander/zandronum"
      zandronum_version:
        description: "Zandronum version to build (ignored if zandronum_url is set)"
        required: true
        default: "3.2.1"
      zandronum_url:
        description: "Optional explicit Zandronum archive URL (overrides version if set)"
        required: false
        default: ""
      push_latest:
        description: "Also push the :latest tag"
        required: true
        type: boolean
        default: false
      platforms:
        description: "Build platforms (comma-separated). Note: Zandronum download is x86_64 by default."
        required: true
        default: "linux/amd64"

  push:
    tags:
      - "v*"

permissions:
  contents: read

concurrency:
  group: dockerhub-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Derive settings from either tag push or workflow_dispatch inputs
      - name: Resolve build variables
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            # Tag push, e.g. refs/tags/v3.2.1
            TAG_NAME="${GITHUB_REF_NAME}"
            VERSION="${TAG_NAME#v}"

            # Default image name for tag builds:
            # Set this to your preferred repo, or replace with a repo secret if you prefer.
            IMAGE_NAME="${{ vars.DOCKERHUB_IMAGE_NAME }}"
            if [[ -z "${IMAGE_NAME}" ]]; then
              echo "DOCKERHUB_IMAGE_NAME variable is not set. Create it (e.g., 'lancommander/zandronum') or use workflow_dispatch."
              exit 1
            fi

            ZANDRONUM_VERSION="${VERSION}"
            ZANDRONUM_URL=""
            PUSH_LATEST="false"
            PLATFORMS="linux/amd64"
          else
            IMAGE_NAME="${{ inputs.image_name }}"
            ZANDRONUM_VERSION="${{ inputs.zandronum_version }}"
            ZANDRONUM_URL="${{ inputs.zandronum_url }}"
            PUSH_LATEST="${{ inputs.push_latest }}"
            PLATFORMS="${{ inputs.platforms }}"
            VERSION="${ZANDRONUM_VERSION}"
          fi

          echo "image_name=${IMAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "zandronum_version=${ZANDRONUM_VERSION}" >> "$GITHUB_OUTPUT"
          echo "zandronum_url=${ZANDRONUM_URL}" >> "$GITHUB_OUTPUT"
          echo "push_latest=${PUSH_LATEST}" >> "$GITHUB_OUTPUT"
          echo "platforms=${PLATFORMS}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU (multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Generates tags/labels. Weâ€™ll produce:
      # - :<version>
      # - :latest (optional)
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.vars.outputs.image_name }}
          tags: |
            type=raw,value=${{ steps.vars.outputs.version }}
            type=raw,value=latest,enable=${{ steps.vars.outputs.push_latest == 'true' }}
          labels: |
            org.opencontainers.image.title=Zandronum Server
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: ${{ steps.vars.outputs.platforms }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            ZANDRONUM_VERSION=${{ steps.vars.outputs.zandronum_version }}
            ZANDRONUM_URL=${{ steps.vars.outputs.zandronum_url }}

      # Optional: provide a short summary in the GitHub Actions UI
      - name: Summary
        run: |
          echo "Pushed image: ${{ steps.vars.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Tags: ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "Zandronum version: ${{ steps.vars.outputs.zandronum_version }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.vars.outputs.zandronum_url }}" ]; then
            echo "Zandronum URL override: ${{ steps.vars.outputs.zandronum_url }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "Platforms: ${{ steps.vars.outputs.platforms }}" >> $GITHUB_STEP_SUMMARY
